language: generic
dist: trusty
sudo: false
matrix:
  include:
    # Versions before 3.8 are not included nor whitelisted

    # Broken (uses ubuntu's version, not llvm one. {LLVM,Clang}Config.cmake are beyond redemption
    #- env: [ "V=3.8", "PREFIX=/usr/lib/llvm-3.8" ]
    #  addons:
    #    apt:
    #      sources: [ "ubuntu-toolchain-r-test", "llvm-toolchain-trusty-3.8" ]
    #      packages: [ "libboost-all-dev", "tcl-dev", "tk-dev", "emacs", "clang-3.8", "libclang-3.8-dev", "llvm-3.8-dev" ]

    # Broken: Unknown relocation 0x2a (llvm-3.9 known to be bugged on travis)
    #- env: [ "V=3.9", "PREFIX=/usr/lib/llvm-3.9/lib/cmake" ]
    #  addons:
    #    apt:
    #      sources: [ "ubuntu-toolchain-r-test", "llvm-toolchain-trusty-3.9" ]
    #      packages: [ "libboost-all-dev", "tcl-dev", "tk-dev", "emacs", "clang-3.9", "libclang-3.9-dev", "llvm-3.9-dev" ]

    # Works, with heavy fixing (see below)
    - env: [ "V=4.0", "PREFIX=/usr/lib/llvm-4.0/lib/cmake", "BIN=/usr/lib/llvm-4.0/bin" ]
      addons:
        apt:
          sources: [ "ubuntu-toolchain-r-test", "llvm-toolchain-trusty-4.0" ]
          packages: [ "libboost-all-dev", "tcl-dev", "tk-dev", "emacs", "clang-4.0", "libclang-4.0-dev", "llvm-4.0-dev", "clang-format-4.0", "clang-tidy-4.0" ]

before_script:
  - apt list --installed
  - env
  # Fix clang cmake dirs
  - if [ $V == 3.9 ]; then  sudo -E ln -sn /usr/share/llvm-3.9/cmake /usr/lib/llvm-3.9/lib/cmake/clang;     fi

  - if [ $V == 4.0 ]; then  sudo -E ln -sn /usr/share/llvm-4.0/cmake /usr/lib/llvm-4.0/lib/cmake/clang;     fi
  - if [ $V == 4.0 ]; then  sudo -E ln -sn /usr/share/llvm-4.0/cmake /usr/lib/llvm-4.0/lib/cmake/clang-4.0; fi
  - if [ $V == 4.0 ]; then  sudo -E ln -s  /usr/bin/*                /usr/lib/llvm-4.0/bin || true;         fi

script:
  - export SOURCES=$(pwd) && mkdir ../build && cd ../build
  - cmake -DCMAKE_BUILD_TYPE=Release -DMOZART_BOOST_USE_STATIC_LIBS=False -DCMAKE_PROGRAM_PATH=$BIN -DCMAKE_PREFIX_PATH=$PREFIX $SOURCES
  - make dist VERBOSE=1
  - make VERBOSE=1
deploy:
  provider: releases
  file: build/mozart2-*-Source.zip
  api_key:
    secure: MhR6fTj04IEpp3GCdV2ZmGuF87ndaYtGqcaI09KgLWhYE1lE5lMBsFdDjp1tuE+r9Jd1vtF4nMR2z+F+DIXSlCzWpu6cBeEV1xCbMhgN7LLRqC97X4wnXJNoAg0Td1kosuZPpJ6wBF428Jsu0oyhVwwAm7jF2Ag5VvD7phtfmkbRDv3g3ZDI6fsU7b0zv0t9PnspQnkM3FtBuX9ZSYjYGth7Doc+evJ0XRKDQskxHzs46/sFn8ZzxX0A9qO9iVxPIx6uey6ADuPjAecbTu6ySKiEw3YbTqEMvFMIbLQl8EhujUPXjxmyFj3tc6yOQiyedqNPVrE20i4HRvp/sSel6ujrQ4G21vTlrFZUuxQ7iBaaJjfZD3TU+8D/Wi5PSowd0E9QSbLe4Rkryej8Hsb1JB6gUIh/mI2v9ikwuB0E3m5D7Jc9UDVur1xhLzoYvDm2X5DqY2ijycYQ9a3xzpG3yyzaveofWCSQPvOOa59f+e0gH3fZ7/h5/J3yjKVUG4iheP8fyTiqjW/oRA2/9RgHXYv7Fq601kMD4Fu6kTo7uUkELr0yv/7JzQQVLQU0/U/rfE2D5jSoaJqBOcwgLnI5R0kELo7mKQr5AEzMam42YufZmEhYh9qkIFeYDg4bN7+3GXZD0lDLle8iZXxmCuvDzAzfisS1xSJ5wqtyso3g+pc=
